<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="d-flex">
  <!-- Sidebar -->
  <div id="sidebar"></div>

  <!-- Main Content -->
  <div class="container-fluid p-4">
    <h2>Student Management</h2>

    <!-- Add/Edit Student Form -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 id="formTitle">Add New Student</h5>
        <form id="studentform" class="row g-3 align-items-end">
          <!-- Student Code -->
          <div class="col-md-3">
            <label class="form-label">Student Code</label>
            <input type="text" id="student_id_num" class="form-control" required placeholder="Enter Student Code (e.g. I210000000)">
          </div>

          <div class="col-md-4">
            <label class="form-label">Student Name</label>
            <input type="text" id="student_name" class="form-control" required placeholder="Enter Student Name">
          </div>

          <div class="col-md-3">
            <label class="form-label">Card UID</label>
            <input type="text" id="card_uid" class="form-control" placeholder="Enter Card UID">
          </div>

          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Add Student</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Student Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Current Students</h5>
        <table class="table table-striped mt-3" id="studentTable">
          <thead>
            <tr>
              <th>Student Code</th>
              <th>Student Name</th>
              <th>Card UID</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="studentTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const API_BASE = "http://13.214.116.232:5000/api";

    // --- Load Sidebar ---
    fetch("navbar.html")
      .then(res => res.text())
      .then(html => {
        const sidebar = document.getElementById("sidebar");
        sidebar.innerHTML = html;

        const scripts = sidebar.querySelectorAll("script");
        scripts.forEach(oldScript => {
          const newScript = document.createElement("script");
          newScript.text = oldScript.text;
          document.body.appendChild(newScript).remove();
        });

        if (typeof initNavbar === "function") initNavbar();
      });

    document.addEventListener("DOMContentLoaded", () => {
      const route = `${API_BASE}/students`;
      const form = document.getElementById("studentform");
      const idNumInput = document.getElementById("student_id_num");
      const nameInput = document.getElementById("student_name");
      const uidInput = document.getElementById("card_uid");
      const tableBody = document.getElementById("studentTableBody");
      const submitBtn = document.getElementById("submitBtn");
      const formTitle = document.getElementById("formTitle");

      let editingId = null; // holds numeric student_id when editing

      // Load students
      async function loadStudents() {
        try {
          const res = await fetch(route);
          const students = await res.json();
          tableBody.innerHTML = "";

          students.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${s.student_id_num}</td>
              <td>${s.name}</td>
              <td>${s.card_uid || "-"}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2 edit-btn" 
                        data-num="${s.student_id_num}" 
                        data-name="${s.name}" 
                        data-uid="${s.card_uid || ''}">
                  Edit
                </button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${s.student_id}">
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Failed to load students:", err);
        }
      }

      // Add / Update Student
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const student_id_num = idNumInput.value.trim();
        const name = nameInput.value.trim();
        const card_uid = uidInput.value.trim();
        // ‚úÖ Validate Student ID (must start with I + 8 characters)
        const idPattern = /^I[A-Za-z0-9]{8}$/;
        if (!idPattern.test(student_id_num)) {
          alert("‚ùå Student ID must start with 'I' and be exactly 9 characters (e.g., I210000000).");
          return;
        }
        // Validate for name only character and spaces
        const namePattern = /^[A-Za-z\s]+$/;
        if (!namePattern.test(name)) {
          alert("‚ùå Student name can only contain letters and spaces!");
          return;
        }

        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `${route}/${editingId}` : route;

        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ student_id_num, name, card_uid })
          });

          if (res.ok) {
            alert(editingId ? "‚úÖ Student updated successfully!" : "‚úÖ Student added successfully!");
            form.reset();
            submitBtn.textContent = "Add Student";
            formTitle.textContent = "Add New Student";
            editingId = null;
            loadStudents();
          } else {
            const errText = await res.text();
            alert("‚ùå Failed: " + errText);
          }
        } catch (err) {
          console.error("Error submitting form:", err);
          alert("‚ùå Network error");
        }
      });

      // Edit Student
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("edit-btn")) {
          const id = e.target.dataset.id;
          const num = e.target.dataset.num;
          const name = e.target.dataset.name;
          const uid = e.target.dataset.uid;

          editingId = id;
          idNumInput.value = num;
          nameInput.value = name;
          uidInput.value = uid;

          submitBtn.textContent = "Update Student";
          formTitle.textContent = "Edit Student";
        }
      });

      // Delete Student
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const id = e.target.dataset.id;
          if (!confirm(`Are you sure you want to delete this student (ID: ${id})?`)) return;

          try {
            const res = await fetch(`${route}/${id}`, { method: "DELETE" });
            if (res.ok) {
              alert("üóëÔ∏è Student deleted successfully!");
              loadStudents();
            } else {
              const errText = await res.text();
              alert("‚ùå Failed to delete: " + errText);
            }
          } catch (err) {
            console.error("Error deleting student:", err);
            alert("‚ùå Network error");
          }
        }
      });

      loadStudents();
    });
  </script>
</body>
</html>

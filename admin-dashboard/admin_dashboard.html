<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Overview</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="d-flex">

  <!-- Sidebar -->
  <div id="sidebar"></div>

  <!-- Main Content -->
  <div class="container-fluid p-4">
    <h2>Dashboard Overview</h2>

    <!-- Summary Cards -->
    <div class="row mb-4" id="overviewCards">
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Total Students</h5>
            <h3 id="totalStudents">--</h3>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Total Logs</h5>
            <h3 id="totalLogs">--</h3>
          </div>
        </div>
      </div>

      <div class="col-md-3">
  <div class="card text-center shadow-sm">
    <div class="card-body">
      <h5>Scanner Lab A101</h5>
      <p>Status: <span id="scanner1Status" class="badge bg-secondary">Loading...</span></p>
      <button id="scanner1Toggle" class="btn btn-sm btn-secondary" disabled>Loading...</button>
    </div>
  </div>
</div>

<div class="col-md-3">
  <div class="card text-center shadow-sm">
    <div class="card-body">
      <h5>Scanner Lab A102</h5>
      <p>Status: <span id="scanner2Status" class="badge bg-secondary">Loading...</span></p>
      <button id="scanner2Toggle" class="btn btn-sm btn-secondary" disabled>Loading...</button>
    </div>
  </div>
</div>

    <!-- Recent Activity Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Recent Activity</h5>
        <table class="table table-striped mt-3">
          <thead>
            <tr>
              <th>Student</th>
              <th>Room</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="recentActivity"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      const sidebar = document.getElementById("sidebar");
      sidebar.innerHTML = html;

      const scripts = sidebar.querySelectorAll("script");
      scripts.forEach((oldScript) => {
        const newScript = document.createElement("script");
        newScript.text = oldScript.text;
        document.body.appendChild(newScript).remove();
      });

      // Initialize after load
      if (typeof initNavbar === "function") initNavbar();
    });


    // Load overview data
    async function loadOverview() {
      try {
        const res = await fetch("http://18.140.43.246:5000/api/overview");
        const data = await res.json();
        document.getElementById("totalStudents").textContent = data.total_students || 0;
        document.getElementById("totalLogs").textContent = data.total_logs || 0;
      } catch (err) {
        console.error("Failed to load overview:", err);
      }
    }

    // Load recent activity (last 5 logs)
    async function loadRecentActivity() {
      try {
        const res = await fetch("http://18.140.43.246:5000/api/logs");
        const logs = await res.json();

        const tbody = document.getElementById("recentActivity");
        tbody.innerHTML = "";

        logs.slice(0, 5).forEach(log => {
          const date = new Date(log.timestamp);
          const localDate = new Date(date.getTime() + (8*60*60*1000));
          const formattedTime = localDate.toLocaleString('en-MY', {
            timeZone: 'Asia/Kuala_Lumpur',
            hours12 : true
          });

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${log.student_name || "-"}</td>
            <td>${log.room_id || "-"}</td>
            <td>
              <span class="badge ${log.status === 'granted' ? 'bg-success' : 'bg-danger'}">
                ${log.status}
              </span>
            </td>
            <td>${formattedTime}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Failed to load logs", err);
      }
    }
    // Load live scanner status
    async function loadRoomstatus(){
      try {
        const res = await fetch ("http://18.140.43.246:5000/api/rooms");
        const room = await res.json();

        const room101 = room.find(r => r.room_name === "Lab A101");
        const room102 = room.find(r => r.room_name === "Lab A102");

        updateRoomstatus("scanner1Status",room101?.status);
        updateRoomstatus("scanner2Status",room102?.status);
        updateToggleButton("scanner1Toggle",room101);
        updateToggleButton("scanner2Toggle",room102);
      }catch (err) {
        console.error("Failed to load room status", err);
      }
    }  

  // --- Update room status display ---
  function updateRoomstatus(elementId, status) {
    const el = document.getElementById(elementId);
    if (!el) return;

    if (!status) {
      el.className = "badge bg-secondary";
      el.textContent = "Unknown";
      return;
    }

    if (status.toLowerCase() === "online") {
      el.className = "badge bg-success";
      el.textContent = "Online";
    } else {
      el.className = "badge bg-danger";
      el.textContent = "Offline";
    }
  }

  // --- Toggle scanner API call ---
function updateToggleButton(buttonId, room) {
  const btn = document.getElementById(buttonId);
  if (!btn || !room) return;

  btn.textContent = room.status === "online" ? "Turn Off" : "Turn On";
  btn.className = `btn btn-sm ${room.status === "online" ? "btn-danger" : "btn-success"}`;
  btn.disabled = false;

  btn.onclick = async () => {
    const newStatus = room.status === "online" ? "offline" : "online";
    try {
      const res = await fetch(`http://18.140.43.246:5000/api/rooms/${room.room_id}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
      if (res.ok) {
        loadRoomstatus(); // refresh after update
      } else {
        alert("Failed to update scanner status.");
      }
    } catch (err) {
      console.error("Error updating status:", err);
    }
  };
}

    // Load everything
    loadOverview();
    loadRecentActivity();
    loadRoomstatus();

    setInterval (()=> {
      loadRecentActivity();
      loadRoomstatus();
    } , 15000)

// check login status
    document.addEventListener("DOMContentLoaded",()=>{
    const role = localStorage.getItem("role");  
    console.log("Detected role in dashboard",role);
if (!role) {
    // not logged in
    window.location.href = "index.html";
}

if (window.location.pathname.includes("/lecturer/") && role !== "lecturer") {
    alert("Access denied.");
    window.location.href = "index.html";
}
});


  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Overview</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="d-flex">

  <!-- Sidebar -->
  <div id="sidebar"></div>

  <!-- Main Content -->
  <div class="container-fluid p-4">
    <h2>Dashboard Overview</h2>

    <!-- Summary Cards -->
    <div class="row mb-4" id="overviewCards">
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Total Students</h5>
            <h3 id="totalStudents">--</h3>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Total Logs</h5>
            <h3 id="totalLogs">--</h3>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Scanner Room101</h5>
            <p>Status: <span id="scanner1Status" class="badge bg-secondary">Loading...</span></p>
            <small>Last Scan: <span id="scanner1Time">--</span></small>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <h5>Scanner Room102</h5>
            <p>Status: <span id="scanner2Status" class="badge bg-secondary">Loading...</span></p>
            <small>Last Scan: <span id="scanner2Time">--</span></small>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Recent Activity</h5>
        <table class="table table-striped mt-3">
          <thead>
            <tr>
              <th>Student</th>
              <th>Room</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="recentActivity"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Load sidebar
    fetch("navbar.html")
      .then(res => res.text())
      .then(html => { document.getElementById("sidebar").innerHTML = html; });

    // Load overview data
    async function loadOverview() {
      try {
        const res = await fetch("http://18.140.43.246:5000/api/overview");
        const data = await res.json();
        document.getElementById("totalStudents").textContent = data.total_students || 0;
        document.getElementById("totalLogs").textContent = data.total_logs || 0;
      } catch (err) {
        console.error("Failed to load overview:", err);
      }
    }

    // Load recent activity (last 5 logs)
    async function loadRecentActivity() {
      try {
        const res = await fetch("http://18.140.43.246:5000/api/logs");
        const logs = await res.json();

        const tbody = document.getElementById("recentActivity");
        tbody.innerHTML = "";

        logs.slice(0, 5).forEach(log => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${log.student_name || "-"}</td>
            <td>${log.room_id || "-"}</td>
            <td>
              <span class="badge ${log.status === 'granted' ? 'bg-success' : 'bg-danger'}">
                ${log.status}
              </span>
            </td>
            <td>${new Date(log.timestamp).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Failed to load logs", err);
      }
    }
    // Load live scanner status
    async function loadRoomstatus(){
      try {
        const res = await fetch ("http://18.140.43.246:5000/api/rooms");
        const room = await res.json();

        const room101 = rooms.find(r => r.room_id === "Room101");
        const room102 = rooms.find(r => r.room_id === "Room102");

        updateRoomstatus("scanner1status", room101?.status);
        updatedRoomstats("scanner2status", room102?.status);
      }catch (err) {
        console.error("Failed to load room status", err);
      }
    }

    function updatedRoomstats(statusid,status){
      const status1 = document.getElementById(statusid);

      if (!status){
        status1.className = "badge bg-secondary";
        status1.textContent = "Unknown";
        return; 
      }
      if (status.toLowerCase() === "online") {
        status1.className = "badge bg-success";
        status1.textContent = "Online";
      } else {
        status1.className = "badge bg-danger";
        status1.textContent = "Offline";
      }
    }
    // Load everything
    loadOverview();
    loadRecentActivity();
    loadRoomstatus();

    setInterval (()=> {
      loadRecentActivity();
      loadRoomstatus();
    } , 15000)
  </script>
</body>
</html>
